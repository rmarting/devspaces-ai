schemaVersion: 2.2.0
metadata:
  name: vscode-continue-ai-env
  description: "VS Code environment with Continue.dev AI assistant pre-installed"

components:
  # Persistent volume for user home (~/.continue, settings, cache, etc.)
  - name: home-volume
    volume:
      size: 5Gi

  # The VS Code editor component (extensions via .vscode/extensions.json)
  - name: vscode-editor
    container:
      image: quay.io/devfile/universal-developer-image:latest
      #memoryLimit: 4Gi
      mountSources: true
      volumeMounts:
        - name: home-volume
          path: /home/user

  # Optional: Adding a dedicated container for your runtime (e.g., Python, Node)
  - name: runtime
    container:
      image: quay.io/devfile/universal-developer-image:latest
      #memoryLimit: 2Gi

commands:
  # Copy repo .continue/config.yaml to ~/.continue, resolving CONTINUE_API_KEY and CONTINUE_API_URL from env
  # (env vars from OpenShift Secret with mount-as: env). Uses awk to avoid sed back-reference issues.
  - id: copy-continue-config
    exec:
      component: vscode-editor
      commandLine: |
        sh -c "
        echo '[postStart] Copying .continue/config.yaml to ~/.continue (resolving CONTINUE_API_KEY and CONTINUE_API_URL from env)...'
        mkdir -p /home/user/.continue
        name=\"$CONTINUE_MODEL_NAME\"
        key=\"$CONTINUE_MODEL_API_KEY\"
        url=\"$CONTINUE_MODEL_API_URL\"
        awk -v n=\"\$name\" -v k=\"\$key\" -v u=\"\$url\" '
          BEGIN {
            gsub(/\\\\/, \"\\\\\\\\\", n); gsub(/&/, \"\\\\&\", n)
            gsub(/\\\\/, \"\\\\\\\\\", k); gsub(/&/, \"\\\\&\", k)
            gsub(/\\\\/, \"\\\\\\\\\", u); gsub(/&/, \"\\\\&\", u)
          }
          {
            gsub(/\\\$\{CONTINUE_MODEL_NAME\}/, n)
            gsub(/\\\$\{CONTINUE_MODEL_API_KEY\}/, k)
            gsub(/\\\$\{CONTINUE_MODEL_API_URL\}/, u)
            print
          }
        ' \"$PROJECT_SOURCE/.continue/config.yaml\" > /home/user/.continue/config.yaml
        echo '[postStart] Done: .continue/config.yaml copied with API key and URL from workspace env'
        "

  # Install Continue CLI globally
  - id: install-continue-cli
    exec:
      component: vscode-editor
      commandLine: "sh -c \"echo '[postStart] Installing Continue CLI (npm i -g @continuedev/cli)...' && npm i -g @continuedev/cli && echo '[postStart] Done: Continue CLI installed'\""

events:
  postStart:
    - copy-continue-config  
    - install-continue-cli
