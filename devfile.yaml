schemaVersion: 2.2.0
metadata:
  name: vscode-continue-ai-env
  description: "VS Code environment with Continue.dev AI assistant pre-installed"

components:
  # Persistent volume for user home (~/.continue, settings, cache, etc.)
  - name: home-volume
    volume:
      size: 5Gi

  # The VS Code editor component (extensions via .vscode/extensions.json)
  - name: vscode-editor
    container:
      image: quay.io/devfile/universal-developer-image:latest
      #memoryLimit: 4Gi
      mountSources: true
      volumeMounts:
        - name: home-volume
          path: /home/user

  # Optional: Adding a dedicated container for your runtime (e.g., Python, Node)
  - name: runtime
    container:
      image: quay.io/devfile/universal-developer-image:latest
      #memoryLimit: 2Gi

commands:
  # Copy full .continue folder to ~/.continue and resolve env placeholders (Continue model vars + CONTEXT7_API_KEY) from OpenShift Secret (mount-as: env).
  - id: copy-continue-dir
    exec:
      component: vscode-editor
      commandLine: |
        sh -c "
        echo '[postStart] Copying full .continue folder to ~/.continue (resolving env placeholders)...'
        mkdir -p /home/user/.continue
        cp -r \"$PROJECT_SOURCE/.continue/\"* /home/user/.continue/
        name=\"$CONTINUE_MODEL_NAME\"
        key=\"$CONTINUE_MODEL_API_KEY\"
        url=\"$CONTINUE_MODEL_API_URL\"
        ctx7key=\"$CONTEXT7_API_KEY\"
        awk -v n=\"\$name\" -v k=\"\$key\" -v u=\"\$url\" '
          BEGIN {
            gsub(/\\\\/, \"\\\\\\\\\", n); gsub(/&/, \"\\\\&\", n)
            gsub(/\\\\/, \"\\\\\\\\\", k); gsub(/&/, \"\\\\&\", k)
            gsub(/\\\\/, \"\\\\\\\\\", u); gsub(/&/, \"\\\\&\", u)
          }
          {
            gsub(/\\\$\{CONTINUE_MODEL_NAME\}/, n)
            gsub(/\\\$\{CONTINUE_MODEL_API_KEY\}/, k)
            gsub(/\\\$\{CONTINUE_MODEL_API_URL\}/, u)
            print
          }
        ' \"$PROJECT_SOURCE/.continue/config.yaml\" > /home/user/.continue/config.yaml
        awk -v c7=\"\$ctx7key\" '
          BEGIN {
            gsub(/\\\\/, \"\\\\\\\\\", c7)
            gsub(/\"/, \"\\\\\\\"\", c7)
          }
          { gsub(/\\\$\{CONTEXT7_API_KEY\}/, c7); print }
        ' \"$PROJECT_SOURCE/.continue/mcpServers/mcp.json\" > /home/user/.continue/mcpServers/mcp.json
        echo '[postStart] Done: .continue copied with Continue and MCP placeholders resolved from workspace env'
        "

  # Install Continue CLI globally
  - id: install-continue-cli
    exec:
      component: vscode-editor
      commandLine: "sh -c \"echo '[postStart] Installing Continue CLI (npm i -g @continuedev/cli)...' && npm i -g @continuedev/cli && echo '[postStart] Done: Continue CLI installed'\""

events:
  postStart:
    - copy-continue-dir
    - install-continue-cli
